"""
This script reads JSON files of Wanderlog top 20 lists of attractions in various cities and uploads them to Firestore.
"""

import os
import glob
import json
import time
import random
import requests

import firebase_admin
from firebase_admin import credentials, firestore, storage

# â”€â”€â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Where your *_top20.json lives
INPUT_DIR = r"C:\dev\python_runs\scrapy_selenium\quotes-js-project\quotes_js_scraper\python_scripts\wanderlog_attractions_full_top20_municipality"

# Firestore mapping
COUNTRY_ID_MAP = {
    # "orlando": "58152",
    # json files of  wanderlog_attractions_full_top20
    # "abu_dhabi": "85942",
    # "agra": "60",
    # "ahmedabad": "161",
    # "akumal": "81941",
    # "alappuzha": "350",
    # "alibaug": "1480",
    # "alicante": "9772",
    # "allahabad": "785",
    # "almora": "1765",
    # "alwar": "1241",
    # "amer": "146238",
    # "amritsar": "384",
    # "anaheim": "58242",
    # "ankara": "9705",
    # "antalya": "9721",
    # "antwerp": "9714",
    # "ao-nang": "146246",
    # "aracaju": "131147",
    # "arequipa": "131099",
    # "arlington": "58342",
    # "armacao-dos-buzios": "",
    # "arraial-do-cabo": "",
    # "asheville": "58185",
    # "atlanta": "58169",
    # "atlantic-city": "58341",
    # "aurangabad": "607",
    # "austin": "58163",
    # "ayia-napa": "",
    # "ayutthaya": "468",
    # "baku": "82",
    # "balneario-camboriu": "",
    # "baltimore": "58179",
    # "bandung": "133",
    # "banff": "58068",
    # "basel": "9817",
    # "belem": "131114",
    # "belfast": "9688",
    # "belo_horizonte": "131088",
    # "bengaluru": "35",
    # "benidorm": "9761",
    # "bento-goncalves": "",
    # "bergamo": "9849",
    # "bern": "9984",
    # "bhopal": "485",
    # "bhubaneswar": "444",
    # "bikaner": "1089",
    #  "bilbao": "9757",
    # "blumenau": "",
    # "bodh-gaya": "",
    # "bogota": "131077",
    # "bologna": "9672",
    # "bombinhas": "131327",
    # "bonito": "131315",
    # "bournemouth": "9841",
    # "brasilia": "131087",
    # "brighton": "9702",
    # "brisbane": "82577",
    # "bristol": "9692",
    # "brooklyn": "58164",
    # "bucharest": "9646",
    # "bundi": "1159",
    # "burgos": "",
    # "busan": "61",
    # "cabo_frio": "131146",
    # "cabo_san_lucas": "",
    # "cadiz": "9887",
    # "cairns": "82584",
    # "caldas_novas": "131447",
    # "calgary": "58048",
    # "campinas": "131106",
    # "campos_do_jordao": "131151",
    # "canela": "131157",
    # "cannes": "131157",
    # "carcassonne_center": "146468",
    # "cartagena": "131080",

    # "casablanca": "131457",
    # "catania": " 9720",
    # "chalong": "146242",
    # "charlotte": "58193",
    # "chattanooga": "58226",
    # "chengdu": "67",
    # "chennai_(madras)": " 40",
    # "chiang_rai": "257",
    # "christchurch": "82579",
    # "cincinnati": "58201",
    # "clearwater": "58231",
    # "cleveland": "58210",
    # "coimbatore": "371",
    # "coimbra": "9899",
    # "cologne": "9682",
    # "colombo": "43",
    # "colonia-del-sacramento": "131165",
    # "colorado-springs": "58207",
    # "columbus": "58563",
    # "coonoor": "1887",
    # "cordoba": "9812",
    # "cusco": "131074",
    # "da_lat": "174",
    # "da_nang": "49",
    # "dalhousie": "1784",
    # "dallas": "58173",
    # "daman": "1808",
    # "darjeeling": "349",
    # "darwin": "82588",
    # "daytona_beach": "58248",
    # "denver": "58166",
    # "detroit": "58218",
    # "digha": "3129",
    # "diu": "1743",
    # "doha": "85946",
    # "dresden": "9717",
    # "dublin": "57258",
    # "dusseldorf": "9738",
    # "edmonton": "58052",
    # "el_calafate": "131139",
    # "evora": "9785",
    # "fes": "79305",
    # "flagstaff": "58300",
    # "fort_lauderdale": "58177",
    # "fort_myers": "58211",
    # "fort_worth": "58212",
    # "fortaleza": "131091",
    # "frankfurt": "9655",
    # "fredericksburg": "58284",
    # "galveston": "58244",
    # "gandhinagar": "2177",

    # "gangtok": "503",
    # "gdansk": "9722",
    # "gettysburg": "58286",
    # "giza": "79321",
    # "glasgow": "9651",
    # "goiania": null,
    # "gokarna": "2371",
    # "goreme": "9896",
    # "gothenburg": "9843",
    # "gramado": "131103",
    # "granada": "9693",
    # "guanajuato": "81924",
    # "guaruja": "131337",
    # "gurugram_(gurgaon)": "207",
    # "guwahati": "524",
    # "gwalior": "1291",
    # "hakodate": "110",
    # "hakone_machi": "215",
    # "halifax": "58059",
    # "hampi": "696",
    # "hassan": "1668",
    # "heidelberg": "9942",
    # "helsinki": "9667",
    # "heraklion": "9830",
    # "hilo": null,
    # "hobart": "82586",
    # "honolulu": "58153",
    # "houston": "58161",
    # "hua_hin": "128",
    # "hyderabad": "78",
    # "imphal": "1013",
    # "indianapolis": "58205",
    # "indore": "558",
    # "itacare": "1013",
    # "jabalpur": "1406",
    # "jaisalmer": "183",
    # "jakarta": "46",
    # "jammu_city": "981",
    # "jamnagar": "730",
    # "jamshedpur": "1763",
    # "jasper": null,
    # "jerusalem": "85941",
    # "joao_pessoa": "131109",
    # "jodhpur": "143",
    # "junagadh": "994",
    # "kalimpong": "1407",
    # "kaliningrad": "9769",
    # "kalpetta": "1222",
    # "kanazawa": "62",
    # "kanchipuram": "976",
    # "kanpur": "1135",
    # "kansas_city": "58219",
    # "kanyakumari": "926",
    # "kathmandu": "17",
    # "kazan": null,
    # "keystone": "59165",
    # "khajuraho": "850",
    # "kolhapur": "1015",
    # "kollam": "714",
    # "kota_kinabalu": "145",
    # "kottayam": "849",
    # "kovalam": "1966",
    # "kozhikode": "527",
    # "krakow": "9640",
    # "kuala_lumpur": "33",
    # "kumarakom": "2540",
    # "kumbakonam": "1302",
    # "kutch": "1473",
    # "kyiv": "9638",
    # "la_coruna": null"10051",
    # "la_jolla": "147352",
    # "la_paz": "131095",
    # "lahaina": "58203",
    # "lake_louise": "76078",
    # "las-palmas-de-gran-canaria": "9759",
    # "lima": "131076",
    # "limassol": null,9736
    # "liverpool": "9660",
    # "ljubljana": "9703",
    # "lloret_de_mar": "10031",
    # "louisville": "58196",
    # "lucknow": "375",
    # "macau": "105",
    # "madikeri": "1886",
    # "madurai": "615",
    # "mahabaleshwar": "978",
    # "mahabalipuram": "1055",
    # "malaga": "9681",
    # "malmo": "9928",
    # "malvan": "1444",
    # "manali": "146271",
    # "manaus": "131092",
    # "manchester": "9662",
    # "mangalore": "479",
    # "manila": "175",
    # "mar_del_plata": "131110",
    # "marmaris": "9857",
    # "marseille": "9675",
    # "mathura": "1002",
    # "mcleod_ganj": "146282",
    # "mdina": "12491",
    # "memphis": "58224",
    # "merida": "81913",
    # "miami": "58157",
    # "miami_beach": "58180",
    # "minneapolis": "58184",
    # "moab": "58269",
    # "mont-saint-michel": "11489",# Done
    # "monte-carlo": "10792", #Not Done
    # "monterey": "58276",
    # "montevideo": "131084",
    # "morro_de_sao_paulo": "131438",
    # "mount_abu": "877",
    # "mussoorie": "687",
    # "myrtle_beach": "58202",
    # "nagpur": "398",
    # "naha": "50",
    # "nainital": "895",
    # "nara": "99",
    # "nashik": "449",
    # "navi_mumbai": "472",
    # "nerja": "10171",
    # "nha_trang": "93",
    # "niagara_falls": "58058",
    # "nice": "9674",
    # "niteroi": "131125",
    # "noida": "563",
    # "north_vancouver": "58079",
    # "nottingham": "9715",
    # "nuremberg": "9739",
    # "oaxaca": "81911",
    # "ocho_rios": "81213",
    # "omaha": "58213",



    # "ooty_udhagamandalam": "480",
    # "orchha": "2027",
    # "oslo": "9665",
    # "page": "58476",
    # "palakkad": "979",
    # "palm_eagle_beach": "81231",
    # "palma_de_mallorca": "9680",
    # "panama_city_beach": null,
    # "panjim": "287",
    # "patna": "673",
    # "patong": "146244",
    # "pecatu": "954",
    # "penha": "131626",
    # "peterhof": "10595",
    # "petra_wadi_musa": "85958",
    # "phnom_penh": "44",
    # "phoenix": "58181",
    # "pigeon_forge": "58241",
    # "pittsburgh": "58199",
    # "playa_blanca": "10241",
    # "pocos_de_caldas": "131178",
    # "pompeii": "9950",
    # "ponda": "1540",
    # "pondicherry": "334",
    # "port_blair": "589",
    # "portland": "58158",
    # "porto_alegre": "131081",
    # "praia_da_pipa": "131395",
    # "puebla": "81918",
    # "puerto_de_la_cruz": "10123",
    # "puerto_iguazu": "131164",
    # "puerto_plata": "81219",
    # "puerto_vallarta": "81906",
    # "puerto_varas": "131138",
    # "pune": "57",
    # "puno": "131140",
    # "punta_del_este": "131162",
    # "puri": "975",
    # "pushkar": "722",
    # "quebec_city": "58051",
    # "raipur": "798",
    # "rajkot": "894",
    # "rameswaram": "1325",
    # "ranchi": "1177",
    # "ranelagh": null,
    # "ratnagiri": "982",
    # "recife": "131089",
    # "richmond": "58222",
    # "riga": "9659",
    # "rishikesh": "194",
    # "ronda": "10015",
    # "rosario": "131113",
    # "salamanca": "9875"
    
    # "salem": "58289",
    # "salou": "10176",
    # "salt_lake_city": "58216",
    # "salta": "131105",
    # "salvador": "131085",
    # "salzburg": "9750",
    # "san_andres": "131389",
    # "san_jose": "78746",
    # "san_juan": "81189",
    # "san_pedro_de_atacama": "131104",
    # "san_sebastian_donostia": "9783",
    # "santa_barbara": "58206",
    # "santa_fe": "58178",
    # "santa_marta": "131107",
    # "santa_monica": "58228",
    # "santander": "9886",
    # "santos": "131122",
    # "sao_luis": "131131",
    # "sarajevo": "9804",
    # "satara": "948",
    # "savannah": "58174",
    # "sawai_madhopur": "1138",
    # "scottsdale": "58192",
    # "sedona": "58188",
    # "segovia": "10230",
    # "selcuk": "10260",

    # "sheffield": "9708",
    # "shillong": "728",
    # "shimoga": "1942",
    # "shirdi": "1316",
    # "singapore": "7",
    # "sintra": "9915",
    # "srinagar": "256",
    # "st_petersburg": "58204",
    # "stockholm": "9673",
    # "stretford": "12525",
    # "stuttgart": "9737",
    # "surat": "478",
    # "tampa": "58176",
    # "thanjavur": "738",
    # "thiruvananthapuram_(trivandrum)": "200",
    # "thrissur": "536",
    # "tiradentes": "131177",
    # "tiruchirappalli": "805",
    # "tirupati": "914",
    # "titusville": "58748",
    # "toledo": "9852",
    # "torquay": "10143",
    # "torremolinos": "10106",
    # "tucson": "58172",
    # "ubatuba": "131108",
    # "udaipur": "91",
    # "udupi": "1000",
    # "ushuaia": "131119",
    # "vadodara": "348",
    # "valletta": "10033",
    # "valparaiso": "131098",
    # "varanasi": "122",
    # "varkala": "662",
    # "vellore": "1463",
    # "venice": "9634",
    # "victoria": "58050",
    # "vijayawada": "1212",
    # "virginia-beach": "58208",
    # "visakhapatnam": "518",
    # "vitoria": "131127",
    # "vrindavan": "1874",
    # "warangal": "1442",
    # "warsaw": "9642",
    # "wellington": "82582",
    # "willemstad": "81196",
    # "williamsburg": "58275",
    # "wisconsin_dells": "58345",
    # "wroclaw": "9753",
    # "xi'an": "74",
    # "yangon_(rangoon)": "52",
    # "yercaud": "1435",
    # "yerevan": "73",
    # "zaragoza": "9771"
  
    # "aachen": "10184",
    # "ahmadnagar": "1531",
    # "akureyri": "10366",
    # "al_ain": "85962",
    # "alexandria": "79337",
    # "amphawa": "2601",
    # "augsburg": "10086",
    # "bamberg": "10421",
    # "batu": "570",
    # "beppu": "228",
    # "berchtesgaden": "11655",
    # "bhavnagar": "1424",
    # "bhuj": "993",
    # "bonn": "10062",
    # "boulogne_sur_mer": "11668",
    # "bremen": "9837",
    # "brescia": "9856",
    # "broome": "82614",
    # "calangute": "581",
    # "cap-d'agde": "146605",
    # "cavtat": "147011",
    # "ceuta": "10804",
    # "chonburi": "1192"

    # "corfu_town": "10021",
    # "corralejo": "146408",
    # "cremona": "10382",
    # "cuenca": "10291",
    # "dahab": "79333",
    # "dambulla": "1431",
    # "delft": "10193",
    # "delphi": "15400",
    # "deoghar": "2121",
    # "dhaka_city": "283",
    # "dwarka": "1983",
    # "eindhoven": "9985",
    # "ella": "660",
    # "eze": "15794",
    # "garmisch_partenkirchen": "10461",
    # "gaya": "1729",
    # "girona": "9944",
    # "grindelwald": "11423",
    # "groningen": "10186",
    # "gulmarg": "1006",
    # "haarlem": "9997",
    # "hat_yai": "1168",
    # "hikkaduwa": "419",
    # "howrah": "2083",
    # "hubli_dharwad": "1581",
    # "incheon": "129"

    #   "ipoh": "376",
    # "ise": "247",
    # "jaffna": "905",
    # "jalandhar": "1163",
    # "jeddah": "85959",
    # "kamakura": "121",
    # "kanchanaburi": "584",
    # "karachi": "288",
    # "karwar": "1479",
    # "kasaragod": "1312",
    # "kiel": "9954",
    # "kingston": "58067",
    # "koblenz": "10095",
    # "kohima": "2141",
    # "konstanz": "10453",
    # "kota": "1218",
    # "kumamoto": "95",
    # "lampang": "1358",
    # "loreto": "14113",
    # "ludhiana": "1060",
    # "lund": "11061",
    # "maastricht": "9946",
    # "mae-rim": "828",
    # "male": "717",
    # "manama": "85954",
    # "mannheim": "10114"
    
    # "margao": "1699",
    # "mecca": "85998",
    # "medan": "382",
    # "miri": "920",
    # "murcia": "9867",
    # "newcastle": "82608",
    # "nijmegen": "10279",
    # "ninh_binh": "724",
    # "nong_khai": "1590",
    # "nuwara_eliya": "638",
    # "oahu": "58149",
    # "oia": "10698",
    # "pai": "546",
    # "paro": "450",
    # "passau": "11084",
    # "patan_(lalitpur)": "561",
    # "pavia": "10073",
    # "phang_nga": "1401",
    # "pokhara": "117",
    # "porbandar": "1331",
    # "potsdam": "10058",
    # "riyadh": "85956",
    # "rovinj": "10109",
    # "ruifang": "146241",
    # "saint_john": "58082"

    # "sandakan": "1160",
    # "santa-cruz-de-tenerife": "9885",
    # "sapa": "221",
    # "savona": "10590",
    # "semarang": "381",
    # "seogwipo": "285",
    # "sigiriya": "921",
    # "singaraja": "528",
    # "sitges": "10024",
    # "solo": "583",
    # "st-paul-de-vence": "14083",
    # "sukhothai": "1131",
    # "tarifa": "9920",
    # "tarragona": "10025",
    # "taupo": "82615",
    # "tirunelveli": "827",
    # "tiruvannamalai": "1997",
    # "tofino": "58077",
    # "trier": "9839",
    # "trincomalee": "1014",
    # "trogir": "10262",
    # "tropea": "10884",
    # "trujillo": "11706",
    # "ujjain": "1025",
    # "ulaanbaatar": "147",
    # "ulm": "10533"

    # "uppsala": "10876",
    # "vasco_da_gama": "1659",
    # "verdun": "11971",
    # "vicenza": "9832",
    # "vigo": "9914",
    # "vung_tau": "456",
    # "whistler": "58061",
    # "whitehorse": "58087",
    # "wiesbaden": "10037",
    # "winnipeg": "58053",
    # "yulara": "82973",
    # "zermatt": "10136"

    # "corfu": "9686",
    # "corsica": "9644",
    # "cozumel": "81908",
    # "crete": "9628",
    # "fernando_de_noronha": "131172",
    # "fuerteventura": "9685",
    # "gran_canaria": "9639",
    # "grand_cayman": "81187",
    # "ibiza": "9664",
    # "island_of_hawaii": "58155",
    # "island_of_malta": "9648",
    # "islands_of_sicily": "9699",
    # "isle_of_wight": "9749",
    # "jersey": "9844",
    # "kauai": "58167",
    # "key_west": "58165",
    # "langkawi": "146",
    # "lanzarote": "9671",
    # "luzon": "5",
    # "madeira": "9678",
    # "majorca": "9627",
    # "maui": "58151",
    # "menorca": "9718",
    # "new_providence_island": "81190",
    # "phuket": "12",
    # "puerto rico": "81177",
    # "rhodes": "9661",
    # "san_andres_island": "131174",
    # "santorini": "9697",
    # "sardinia": "9619",
    # "sentosa_island": "650",
    # "sicily": "9612",
    # "tenerife": "9632",
    # "vancouver_island": "58044",
    # "zakynthos": "9732"

    
    #Municipalities
    # "adeje": "9826",
    # "adelaide": "82581",
    # "agrigento": "10074",
    # "ajmer": "956",
    # "albufeira": "9765",
    # "albuquerque": "58191",
    # "anchorage": "58198",
    # "angra_dos_reis": "131093",
    # "assisi": "9945",
    # "athens": "9637",
    # "auckland": "82576",
    # "avignon": "9919",
    # "baga": "1868",
    # "bardez": "329",
    # "bath": "9730",
    # "belgrade": "9687",
    # "benalmadena": "9889",
    # "bergen": "9801",
    # "birmingham": "9666",
    # "blackpool": "9798",
    # "bled": "10235",
    # "bophut": "98",
    # "bordeaux": "9663",
    # "branson": "58183",
    # "bratislava": "9696",
    # "bruges": "9745",
    # "brussels": "9649",
    # "canacona": "814",
    # "canberra": "82585",
    # "cancun": "81904",
    # "carcassonne": "9903",
    # "cardiff": "9712",
    # "chandigarh": "304",
    # "charleston": "58170",
    # "chester": "9850",
    # "chiang_mai": "19",
    # "chikmagalur": "787",
    # "chiyoda": "42",
    # "copenhagen": "9643",
    # "dharamsala": "405",
    # "dubai": "85939",
    # "dunedin": "82594",
    # "edinburgh": "9636",
    # "florence": "9630",
    # "florianopolis": "131086",
    # "fukuoka": "31",
    # "funchal": "9735",
    # "galway": "9734",
    # "geneva": "9724",
    # "genoa": "9683",
    # "gold_coast": "82578",
    # "greater_palm_springs": "58182",
    # "haridwar": "783",
    # "hiroshima": "59",
    # "hoi_an": "21",
    # "hong_kong": "15",
    # "innsbruck": "9861",
    # "ipojuca": "131150",
    # "jaipur": "24",
    # "jijoca_de_jericoacoara": "131134",
    # "johannesburg": "79306",
    # "kandy": "118",
    # "kannur": "461",
    # "karon": "176",
    # "kathu": "53",
    # "killarney": "9836",
    # "kobe": "34",
    # "kochi_(cochin)": "68",
    # "kodaikanal": "842",
    # "krabi_town": "79",
    # "kuta": "37",
    # "kyoto": "2",
    # "la_fortuna_de_san_carlos": "78752",
    # "leeds": "9689",
    # "leh": "297",
    # "lincoln": "9917",
    # "lindos": "11769",
    # "llandudno": "9998",
    # "lonavala": "701",
    # "luang_prabang": "184",
    # "lucca": "9840",
    # "lucerne": "10008",
    # "lyon": "9670",
    # "maceio": "131115",
    # "machu_picchu": "131318",
    # "manali_tehsil": "313",
    # "maragogi": "131360",
    # "marne_la_vallee": "10413",
    # "maspalomas": "9792",
    # "mata_de_sao_joao": "131478",
    # "matera": "9891",
    # "medellin": "131079",
    # "mendoza": "131083",
    # "minato": "23",
    # "munnar": "412",
    # "nagoya": "30",
    # "nairobi": "79303",
    # "nantes": "9799",
    # "naples": "9635",
    # "nassau": "81194",
    # "natal": "131100",
    # "new_taipei": "41",
    # "newcastle_upon_tyne": "9713",
    # "niagara_on_the_lake": "58062",
    # "osaka": "3",
    # "ottawa": "58049",
    # "ouro_preto": "131117",
    # "oxford": "9723",
    # "padua": "9690",
    # "pahalgam": "2253",
    # "palermo": "9654",
    # "panama_city": "78744",
    # "paphos": "9763",
    # "paraty": "131094",
    # "pattaya": "80",
    # "petropolis": "131132",
    # "phuket_town": "51",
    # "pisa": "9767",
    # "playa_del_carmen": "81905",
    # "porto_seguro": "131118",
    # "portsmouth": "9803",
    # "punta_cana": "81180",
    # "quito": "131078",
    # "ravenna": "10046",
    # "reykjavik": "9656",
    # "rimini": "9756",
    # "rotorua": "82593",
    # "saint_louis": "58175",
    # "san_carlos_de_bariloche": "131090",
    # "san_diego": "58150",
    # "santiago_de_compostela": "9838",
    # "sapporo": "29",
    # "trieste": "9691",
    # "tulum": "81909",
    # "ubud": "22",
    # "varadero": "81226",
    # "verona": "9711",
    # "versailles": "10061",
    # "vila_nova_de_gaia": "10211",
    # "weymouth": "10064",
    # "windsor": "10219",
    # "yokohama": "20",
    # "york": "9707",
    # "zurich": "9668",
    # "sarasota": "58187",
    # "scarborough": "9937",
    # "sharm_el_sheikh": "79309",
    # "shibuya": "38",
    # "shimla": "428",
    # "shinjuku": "32",
    # "siem_reap": "11",
    # "siena": "9802",
    # "sochi": "9677",
    # "sofia": "9676",
    # "split": "9694",
    # "st_augustine": "58186",
    # "st_petersburg": "9618",
    # "strasbourg": "9751",
    # "stratford_upon_avon": "9930",
    # "sydney": "82574",
    # "syracuse": "9800",
    # "taipei": "18",
    # "taito": "28",
    # "tallinn": "9679",
    # "taormina": "9935",
    # "tel_aviv": "85940",
    # "thane": "541",
    # "the_hague": "9725",
    # "thekkady": "753",
    # "thessaloniki": "9727",
    # "toulouse": "9709"     
    # â€¦etcâ€¦
}

# Firebase creds & bucket
SERVICE_ACCOUNT_PATH = r"C:\dev\python_runs\scrapy_selenium\quotes-js-project\mycasavsc-firebase-adminsdk-u26li-ff3db6bf13.json"
STORAGE_BUCKET       = "mycasavsc.appspot.com"

# Wanderlog CDN prefix for your scraped imageKeys
WANDERLOG_IMG_PREFIX = "https://itin-dev.wanderlogstatic.com/freeImage/"

# How many from each source?
N_WANDERLOG = 2
N_GOOGLE    = 3

# Google Places API
GOOGLE_API_KEY    = "AIzaSyBe-suda095R60l0G1NrdYeIVKjUCxwK_8"
API_CALL_INTERVAL = 0.3  # throttle

# â”€â”€â”€â”€â”€ FIREBASE INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cred = credentials.Certificate(SERVICE_ACCOUNT_PATH)
firebase_admin.initialize_app(cred, {"storageBucket": STORAGE_BUCKET})
db     = firestore.client()
bucket = storage.bucket()


# â”€â”€â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def get_google_photo_urls(place_id, max_photos=5):
    """Fetch up to max_photos from Google Places Details."""
    url = "https://maps.googleapis.com/maps/api/place/details/json"
    params = {
        "place_id": place_id,
        "fields":   "photos",
        "key":      GOOGLE_API_KEY,
    }
    time.sleep(API_CALL_INTERVAL)
    result = requests.get(url, params=params).json().get("result", {})
    urls = []
    for p in result.get("photos", [])[:max_photos]:
        ref = p.get("photo_reference")
        urls.append(
            f"https://maps.googleapis.com/maps/api/place/photo?"
            f"maxwidth=800&photo_reference={ref}&key={GOOGLE_API_KEY}"
        )
    return urls

def download_and_upload_image(url, place_id, idx):
    """Download an image with retries, upload to Storage under lp_attractions/â€¦, return public URL."""
    backoff = 1
    for attempt in range(3):
        try:
            resp = requests.get(url, timeout=20)
            resp.raise_for_status()
            data = resp.content
            break
        except Exception:
            time.sleep(backoff)
            backoff *= 2
    else:
        print(f"   âš ï¸  Failed to download {url}")
        return None

    blob_path = f"lp_attractions/{place_id}_{idx}.jpg"
    blob = bucket.blob(blob_path)
    blob.upload_from_string(data, content_type="image/jpeg")
    blob.make_public()
    return blob.public_url


# â”€â”€â”€â”€â”€ UPLOAD LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def main():
    pattern = os.path.join(INPUT_DIR, "*_top20.json")
    for path in glob.glob(pattern):
        slug       = os.path.basename(path).split("_attractions_full_top20")[0]
        country_id = COUNTRY_ID_MAP.get(slug)
        if not country_id:
            print(f"[!] No mapping for '{slug}', skipping.")
            continue

        print(f"\nâ–¶ Processing city '{slug}' â†’ countryId={country_id}")
        records = json.load(open(path, encoding="utf-8"))

        coll = (db.collection("allplaces")
                  .document(country_id)
                  .collection("top_attractions"))

        for rec in records:
            pid  = rec.get("placeId")
            name = rec.get("name")
            lat  = rec.get("latitude")
            lon  = rec.get("longitude")

            # 1) Wanderlog images
            wander_urls = [
                f"{WANDERLOG_IMG_PREFIX}{key}"
                for key in rec.get("imageKeys", [])
            ]
            wander_pick = random.sample(wander_urls, 
                                        min(N_WANDERLOG, len(wander_urls)))

            # 2) Google photos (use existing placeId)
            google_urls = []
            if GOOGLE_API_KEY and pid:
                google_urls = get_google_photo_urls(pid)
            google_pick = random.sample(google_urls,
                                        min(N_GOOGLE, len(google_urls)))

            # 3) Merge & upload
            final = wander_pick + google_pick
            uploaded = []
            for idx, url in enumerate(final, start=1):
                up = download_and_upload_image(url, pid, idx)
                if up:
                    uploaded.append(up)

            # store back into record
            rec["g_image_urls"] = uploaded
            if uploaded:
                rec["image_url"] = uploaded[0]

            # 4) Write to Firestore
            coll.document(pid).set(rec)
            print(f"   âœ…  {pid} â€“ {name} ({len(uploaded)} images)")

    print("\nğŸ‰  All done.")

if __name__ == "__main__":
    main()
